# Step 5.2: Monitoring and Alerting - COMPLETE ✅

## Overview

Implemented comprehensive monitoring and alerting for the Market Data Service using Prometheus and Grafana.

## What Was Implemented

### 1. Prometheus Metrics (`internal/metrics/`)

Created a complete metrics collection system with the following metric categories:

#### gRPC Metrics
- `market_data_grpc_requests_total` - Total gRPC requests by method and status
- `market_data_grpc_request_duration_seconds` - Request duration histogram
- `market_data_grpc_active_streams` - Number of active streaming connections
- `market_data_grpc_stream_subscriptions_total` - Stream subscription actions
- `market_data_grpc_stream_messages_total` - Messages sent through streams
- `market_data_grpc_errors_total` - gRPC errors by method and type

#### Cache Metrics
- `market_data_cache_hits_total` - Cache hit counter
- `market_data_cache_misses_total` - Cache miss counter
- `market_data_cache_errors_total` - Cache error counter
- `market_data_cache_operation_duration_seconds` - Cache operation duration

#### Database Metrics
- `market_data_db_queries_total` - Database queries by operation and status
- `market_data_db_query_duration_seconds` - Query duration histogram
- `market_data_db_connection_pool_active` - Active database connections
- `market_data_db_connection_pool_idle` - Idle database connections
- `market_data_db_errors_total` - Database errors by operation and type

#### Price Oscillation Metrics
- `market_data_price_updates_total` - Total price updates generated
- `market_data_active_subscribers` - Number of active subscribers
- `market_data_active_symbols` - Number of symbols with subscriptions
- `market_data_price_oscillation_duration_seconds` - Price oscillation cycle duration
- `market_data_quotes_generated_total` - Quotes generated by symbol

#### System Metrics
- `market_data_service_uptime_seconds` - Service uptime
- `market_data_service_info` - Service version and build information

### 2. Metrics HTTP Endpoint

- **Endpoint**: `http://localhost:8083/metrics`
- **Format**: Prometheus text format
- **Update Frequency**: Real-time
- Integrated into `cmd/server/main.go` with dedicated HTTP server

### 3. Prometheus Configuration

**File**: `deployments/prometheus/prometheus.yml`

- Scrape interval: 15s
- Evaluation interval: 15s
- Targets:
  - Market Data Service (port 8083)
  - PostgreSQL Exporter (port 9187)
  - Redis Exporter (port 9121)
  - Node Exporter (port 9100)

### 4. Alert Rules

**File**: `deployments/prometheus/alerts/market_data_alerts.yml`

Configured 12 alert rules:

#### Critical Alerts
1. **ServiceDown** - Service unavailable for >1 minute
2. **CriticalLatency** - P95 latency >5 seconds
3. **PriceUpdateStalled** - No price updates despite active subscribers

#### Warning Alerts
4. **HighErrorRate** - Error rate >5% for 5 minutes
5. **HighLatency** - P95 latency >1 second for 5 minutes
6. **LowCacheHitRate** - Cache hit rate <50% for 10 minutes
7. **DBConnectionPoolExhaustion** - >90% connections in use
8. **HighDatabaseQueryDuration** - P95 query duration >2 seconds
9. **HighMemoryUsage** - Memory usage >800MB
10. **HighCacheErrorRate** - Cache errors >0.01/second

#### Info Alerts
11. **NoActiveStreams** - No streaming connections despite requests

### 5. Grafana Dashboard

**File**: `deployments/grafana/dashboard.json`

Created a comprehensive dashboard with 12 panels:

1. **gRPC Request Rate** - Requests per second by method and status
2. **gRPC Request Duration (p95)** - 95th percentile latency
3. **Active gRPC Streams** - Real-time stream count
4. **Stream Subscriptions** - Subscribe/unsubscribe rate
5. **Cache Hit Rate** - Cache effectiveness percentage
6. **Cache Operations** - Hits, misses, and errors
7. **Database Query Duration (p95)** - Database performance
8. **Database Connection Pool** - Active vs idle connections
9. **Active Subscribers & Symbols** - Real-time subscription metrics
10. **Price Updates Rate** - Quote generation rate
11. **Quotes Generated by Symbol** - Per-symbol quote distribution
12. **Error Rate** - Combined gRPC and database errors

### 6. Docker Compose Integration

Added to `docker-compose.yml`:

#### Prometheus Container
- **Port**: 9090
- **Volume**: `prometheus_data` for persistent storage
- **Config**: Mounted from `hub-market-data-service/deployments/prometheus/`
- **Features**: Web UI, lifecycle API enabled

#### Grafana Container
- **Port**: 3000
- **Credentials**: admin/admin (change in production)
- **Volume**: `grafana_data` for persistent storage
- **Dashboards**: Auto-provisioned from `hub-market-data-service/deployments/grafana/`

## How to Use

### Access Monitoring Tools

1. **Prometheus UI**: http://localhost:9090
   - Query metrics
   - View targets
   - Check alert status

2. **Grafana UI**: http://localhost:3000
   - Username: `admin`
   - Password: `admin`
   - Dashboard: "Market Data Service - Monitoring Dashboard"

3. **Metrics Endpoint**: http://localhost:8083/metrics
   - Raw Prometheus metrics
   - Useful for debugging

### Start Monitoring Stack

```bash
# Start all services including monitoring
make start

# Or start only monitoring services
docker-compose up -d prometheus grafana
```

### View Metrics

```bash
# Check if metrics endpoint is working
curl http://localhost:8083/metrics

# Check Prometheus targets
curl http://localhost:9090/api/v1/targets

# Check active alerts
curl http://localhost:9090/api/v1/alerts
```

### Example Prometheus Queries

```promql
# Request rate by method
rate(market_data_grpc_requests_total[5m])

# P95 latency
histogram_quantile(0.95, rate(market_data_grpc_request_duration_seconds_bucket[5m]))

# Cache hit rate
rate(market_data_cache_hits_total[5m]) / 
(rate(market_data_cache_hits_total[5m]) + rate(market_data_cache_misses_total[5m]))

# Error rate
rate(market_data_grpc_errors_total[5m]) + rate(market_data_db_errors_total[5m])

# Active streams
market_data_grpc_active_streams

# Price update rate
rate(market_data_price_updates_total[5m])
```

## Alert Configuration

### Alertmanager Setup (Optional)

To receive alert notifications:

1. Configure Alertmanager in `docker-compose.yml`
2. Set up notification channels (email, Slack, PagerDuty)
3. Update `prometheus.yml` with Alertmanager endpoint

Example Alertmanager config:
```yaml
alertmanager:
  image: prom/alertmanager:latest
  ports:
    - "9093:9093"
  volumes:
    - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
```

## Monitoring Best Practices

### 1. Set Appropriate Thresholds
- Adjust alert thresholds based on your SLAs
- Use percentiles (p95, p99) for latency alerts
- Consider business hours vs off-hours

### 2. Reduce Alert Fatigue
- Use `for` duration to avoid flapping
- Group related alerts
- Set appropriate severity levels

### 3. Regular Review
- Review dashboards weekly
- Analyze trends and patterns
- Adjust thresholds as needed

### 4. Capacity Planning
- Monitor resource usage trends
- Plan scaling based on metrics
- Set up predictive alerts

## Next Steps

### Recommended Enhancements

1. **Custom Metrics**
   - Add business-specific metrics
   - Track SLA compliance
   - Monitor data quality

2. **Distributed Tracing**
   - Integrate Jaeger or Zipkin
   - Trace requests across services
   - Identify bottlenecks

3. **Log Aggregation**
   - Set up ELK or Loki
   - Correlate logs with metrics
   - Centralized log search

4. **Synthetic Monitoring**
   - Health check endpoints
   - Periodic smoke tests
   - External monitoring

## Files Created

```
hub-market-data-service/
├── internal/
│   └── metrics/
│       ├── metrics.go          # Prometheus metrics definitions
│       └── handler.go          # HTTP handler for /metrics
├── deployments/
│   ├── prometheus/
│   │   ├── prometheus.yml      # Prometheus configuration
│   │   └── alerts/
│   │       └── market_data_alerts.yml  # Alert rules
│   └── grafana/
│       └── dashboard.json      # Grafana dashboard
└── docs/
    └── STEP_5_2_MONITORING_COMPLETE.md  # This file
```

## Testing

### Verify Metrics Collection

```bash
# 1. Check metrics endpoint
curl http://localhost:8083/metrics | grep market_data

# 2. Verify Prometheus is scraping
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.labels.job=="market-data-service")'

# 3. Test a query
curl -G http://localhost:9090/api/v1/query \
  --data-urlencode 'query=market_data_grpc_requests_total'

# 4. Check alerts
curl http://localhost:9090/api/v1/alerts | jq '.data.alerts[] | select(.labels.service=="market-data")'
```

### Generate Test Load

```bash
# Generate some requests to see metrics
grpcurl -plaintext \
  -d '{"symbol": "AAPL"}' \
  localhost:50054 \
  hub_investments.MarketDataService/GetMarketData

# Check updated metrics
curl http://localhost:8083/metrics | grep grpc_requests_total
```

## Troubleshooting

### Metrics Not Appearing

1. **Check metrics endpoint**:
   ```bash
   curl http://localhost:8083/metrics
   ```

2. **Verify Prometheus target**:
   - Open http://localhost:9090/targets
   - Check if `market-data-service` is UP

3. **Check service logs**:
   ```bash
   docker logs hub-market-data-service | grep metrics
   ```

### Grafana Dashboard Not Loading

1. **Verify Grafana is running**:
   ```bash
   docker ps | grep grafana
   ```

2. **Check dashboard provisioning**:
   ```bash
   docker exec hub-grafana ls /etc/grafana/provisioning/dashboards
   ```

3. **Import dashboard manually**:
   - Open http://localhost:3000
   - Go to Dashboards → Import
   - Upload `deployments/grafana/dashboard.json`

### Alerts Not Firing

1. **Check alert rules**:
   ```bash
   curl http://localhost:9090/api/v1/rules
   ```

2. **Verify alert conditions**:
   - Open http://localhost:9090/alerts
   - Check if conditions are met

3. **Test alert manually**:
   ```promql
   # Force an alert by querying
   market_data_grpc_active_streams > -1
   ```

## Summary

✅ **Completed**:
- Comprehensive Prometheus metrics
- 12 alert rules (3 critical, 8 warning, 1 info)
- Grafana dashboard with 12 panels
- Docker Compose integration
- Metrics HTTP endpoint
- Documentation and examples

**Deliverable**: Full monitoring and alerting setup for Market Data Service

---

**Date**: November 2, 2025  
**Status**: COMPLETED ✅

